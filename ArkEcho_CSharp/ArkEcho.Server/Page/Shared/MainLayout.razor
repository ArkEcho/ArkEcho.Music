@inherits LayoutComponentBase

@using System.Security.Claims
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject Blazored.LocalStorage.ILocalStorageService localStorageService
@inject IJSRuntime jsRunTime

<div class="page">
	<div class="sidebar">
		<NavMenu />
	</div>

	<div class="main">
		<div class="top-row px-4">
			<AuthorizeView>
				<Authorized>
					<button class="btn btn-secondary" @onclick="UserIconClick">User</button>
				</Authorized>
				<NotAuthorized>
					NOT AUTHORIZED
				</NotAuthorized>
			</AuthorizeView>
		</div>

		<div class="sidebar py-4 px-4 float-right" style="background-color:lightgray; display: @showUserSidebarCss">
			<h2>@LoggedInText</h2>
			<button class="btn btn-primary" @onclick="Logout">Logout</button>
		</div>
		<div class="content px-4">
			@Body
		</div>
	</div>
</div>

@code
{ //ds
	[CascadingParameter]
	private Task<AuthenticationState> authenticationStateTask { get; set; }
	ClaimsPrincipal claimsPrincipal;

	private bool showUserSidebar = false;
	private string showUserSidebarCss => showUserSidebar ? "block" : "none";

	public string LoggedInText { get; set; } = string.Empty;

	protected override async Task OnInitializedAsync()
	{
		claimsPrincipal = (await authenticationStateTask).User;

		LoggedInText = claimsPrincipal.Identities.ToList().Find(x => x.NameClaimType.Equals(ClaimTypes.Name, StringComparison.OrdinalIgnoreCase)).Name;

		if (!claimsPrincipal.Identity.IsAuthenticated)
			NavigationManager.NavigateTo("/");
	}
	public async Task UserIconClick()
	{
		showUserSidebar = !showUserSidebar;
		StateHasChanged();
		//await ((CustomAuthenticationStateProvider)AuthenticationStateProvider).MarkUserAsLoggedOut();
		//NavigationManager.NavigateTo("/");
	}
	public async Task Logout()
	{
		await ((CustomAuthenticationStateProvider)AuthenticationStateProvider).MarkUserAsLoggedOut();
		NavigationManager.NavigateTo("/");
	} }