@inject IAppModel Model

<MudAppBar Class="rounded-pill" Bottom="true" Fixed="true" Color="Color.Secondary" Elevation="1">

    <MudPaper Class="d-flex flex-none justify-start mud-theme-secondary" Elevation="0" Width="200px">

        <MudPaper MaxHeight="100%" MaxWidth="50px" Class="d-flex mud-theme-secondary">
            <MudImage Fluid="true" ObjectFit="ObjectFit.ScaleDown" Src="@Image64" />
        </MudPaper>

        <MudText Class="ml-4" Inline="true" Typo="Typo.body2">@SongTitle<br />@SongPerformer</MudText>
    </MudPaper>

    <MudPaper Class="d-flex flex-grow-1 justify-center mud-theme-secondary" Elevation="0">
        
        <MudPaper Class="pt-2 mr-4 mud-theme-secondary d-none d-sm-flex" Elevation="0">
            <MudText Typo="Typo.body2">@Position</MudText>
        </MudPaper>

        <MudIconButton Class="mx-1 d-none d-sm-flex" OnClick="stop" Icon="@Icons.Material.Rounded.Stop" Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Medium" />
        <MudIconButton Class="mx-1 d-none d-md-flex" OnClick="shuffle" Icon="@ShuffleIcon" Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Medium" />

        <MudIconButton Class="mx-1" OnClick="backward" Icon="@Icons.Material.Rounded.FastRewind" Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Medium" />

        <MudFab Class="mx-1" OnClick="playPause" Icon="@PlayPauseIcon" Color="Color.Primary" Size="Size.Small" />

        <MudIconButton Class="mx-1" OnClick="forward" Icon="@Icons.Material.Rounded.FastForward" Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Medium" />

        <MudIconButton Class="mx-1 d-none d-md-flex" OnClick="mute" Icon="@MuteIcon" Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Medium" />
        <MudPaper Class="mx-1 pt-3 mud-theme-secondary d-none d-sm-flex" Elevation="0" Width="100px">
            <MudSlider Size="Size.Medium" Min="0" Max="100" Step="5" @bind-Value="Model.Player.Volume" ValueLabel="true" />
        </MudPaper>

    </MudPaper>

    <MudPaper Class="d-none d-sm-flex flex-grow-1" MaxWidth="200px" />

</MudAppBar>

@code
{
    public string PlayPauseIcon { get { return Model.Player.Playing ? Icons.Material.Rounded.Pause : Icons.Material.Rounded.PlayArrow; } }
    public string MuteIcon { get { return Model.Player.Mute ? Icons.Material.Rounded.VolumeOff : Icons.Material.Rounded.VolumeUp; } }
    public string ShuffleIcon { get { return Model.Player.Shuffle ? Icons.Material.Rounded.ShuffleOn : Icons.Material.Rounded.Shuffle; } }
    public string Position 
    { 
        get
        {
            TimeSpan time = TimeSpan.FromSeconds(Model.Player.Position);
            return time.ToString(@"mm\:ss");
        } 
    }
    public string SongTitle { get { return playingTitle != null ? playingTitle.Title : string.Empty; } }
    public string SongPerformer { get { return playingTitle != null ? playingTitle.Performer : string.Empty; } }
    public string AlbumName { get { return playingTitle != null ? playingAlbum.Name : string.Empty; } }
    public string AlbumArtistName { get { return playingTitle != null ? playingAlbumArtist.Name : string.Empty; } }

    private string Image64 = string.Empty;
    private MusicFile playingTitle = null;
    private Album playingAlbum = null;
    private AlbumArtist playingAlbumArtist = null;

    private void playPause()
    {
        Model.Player.PlayPause();
    }

    private void backward()
    {
        Model.Player.Backward();
    }

    private void forward()
    {
        Model.Player.Forward();
    }

    private void stop()
    {
        Model.Player.Stop();
    }

    private void shuffle()
    {
        Model.Player.Shuffle = !Model.Player.Shuffle;
    }

    private void mute()
    {
        Model.Player.Mute = !Model.Player.Mute;
    }

    protected override async Task OnInitializedAsync()
    {
        Model.Player.TitleChanged += () => titleChanged();
        Model.Player.PositionChanged += () => positionChanged();
        Model.Player.PlayingChanged += () => playingChanged();

        await InvokeAsync(StateHasChanged);

        await base.OnInitializedAsync();
    }

    private async Task titleChanged()
    {
        playingTitle = Model.Player.PlayingFile;

        if (playingTitle != null && (playingAlbum == null || playingAlbum.GUID != playingTitle.GUID))
        {
            playingAlbum = Model.Library.Album.Find(x => x.GUID == playingTitle.Album);
            playingAlbumArtist = Model.Library.AlbumArtists.Find(x => x.GUID == playingAlbum.GUID);

            string result = await Model.GetAlbumCover(playingAlbum.GUID);
            Image64 = $"data:image/png;base64,{result}";
        }
        else
        {
            playingAlbum = null;
            Image64 = string.Empty;            
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task positionChanged()
    {
        await InvokeAsync(StateHasChanged);
    }

    private async Task playingChanged()
    {
        await InvokeAsync(StateHasChanged);
    }
}
