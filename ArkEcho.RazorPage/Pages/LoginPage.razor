@page "/"

@layout CenteredCardLayout

@inject IAppModel model
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<MudPaper Class="pa-2" Outlined="true">
    <MudStack>
        <svg width="100%" height="200px" color="white">
            @((MarkupString)ArkEcho.Core.Properties.Resources.logo_svg)
        </svg>

        <MudTextField Class="mt-2" Label="Username" Variant="Variant.Outlined" Immediate="true" @bind-Value="username" @onkeypress="inputKeyPress">Username</MudTextField>

        <MudTextField Class="mt-2" Label="Password" Variant="Variant.Outlined" @bind-Value="password" Immediate="true" InputType="@PasswordInput" @onkeypress="inputKeyPress"
                        Adornment="Adornment.End" AdornmentIcon="@PasswordInputIcon" OnAdornmentClick="passwordAdornmentClick" AdornmentAriaLabel="Show Password" />
        
        <MudButton Class="mt-2" Variant="Variant.Filled" Color="Color.Tertiary" OnClick="validateUser" Disabled="@(model.AppStatus != IAppModel.Status.Initialized)">Login</MudButton>
        <AppStatus />
    </MudStack>
</MudPaper>

<MudOverlay @bind-Visible="overlayVisible" DarkBackground="true" ZIndex="9999">
    <MudProgressCircular Color="Color.Tertiary" Size="Size.Large" Indeterminate="true" />
</MudOverlay>

@code
{
    // TODO: Connection status und Reconnent Button unter Login anzeigen
    private bool overlayVisible = false;

    private string username = string.Empty;
    private string password = string.Empty;

    bool isShow;
    InputType PasswordInput = InputType.Password;
    string PasswordInputIcon = Icons.Material.Filled.VisibilityOff;

    private async Task inputKeyPress(KeyboardEventArgs e)
    {
        if (e.Key.Equals("Enter", StringComparison.OrdinalIgnoreCase) && model.AppStatus == IAppModel.Status.Initialized)
            await validateUser();
    }

    protected async override Task OnInitializedAsync()
    {
        model.StatusChanged += () => onAppStatusChanged();

        if (await model.IsUserAuthenticated())
        {
            showOverlay(true);
            await model.InitializeOnLoad();
            await model.InitializeOnLogin();
            showOverlay(false);

            NavigationManager.NavigateTo("/Music");
            return;
        }

        await model.InitializeOnLoad();
    }

    private async Task onAppStatusChanged()
    {
        if (model.AppStatus == IAppModel.Status.Initialized)
            StateHasChanged();
    }

    private async Task validateUser()
    {
        if (string.IsNullOrEmpty(username) || string.IsNullOrEmpty(password))
        {
            showSnackbarError($"Empty username or password!");
            return;
        }

        if(await model.AuthenticateUser(username, password))
        {
            showOverlay(true);
            await model.InitializeOnLogin();
            showOverlay(false);
            NavigationManager.NavigateTo("/Music");            
        }
        else
            showSnackbarError($"Username or Password wrong!");

        return;
    }

    private void showOverlay(bool show)
    {
        overlayVisible = show;
        StateHasChanged();
    }

    private void showSnackbarError(string message)
    {
        Snackbar.Add(message, Severity.Error, config => { config.ShowCloseIcon = true; });
    }

    private void passwordAdornmentClick()
    {
        @if (isShow)
        {
            isShow = false;
            PasswordInputIcon = Icons.Material.Filled.VisibilityOff;
            PasswordInput = InputType.Password;
        }
        else
        {
            isShow = true;
            PasswordInputIcon = Icons.Material.Filled.Visibility;
            PasswordInput = InputType.Text;
        }
    }
}